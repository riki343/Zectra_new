{% extends '@Zectranet/index.html.twig' %}

{% block title %}{{ project.name }}{% endblock %}

{% block body %}
    <div ng-controller="ProjectController" ng-init="getEpicStories({{ project.id }})">
        <div class="row">
            <ol class="breadcrumb" style="margin: 0 -15px;">
                <li>
                    <a href="{{ path('zectranet_user_home') }}">Summary</a>
                </li>
                <li class="active">
                    {{ project.name }}
                </li>
            </ol>
        </div>

        <div class="page-header">
            <div class="row">
                <div class="col-md-6">
                    <i class="fa fa-briefcase fa-2x"></i>
                    <span style="font-size: 25px;">{{ project.name }}</span>
                </div>
                <div class="col-md-6">
                    <!-- Begin of Project controll buttons -->
                    {% if project.owner.id == app.user.id or (is_granted('ROLE_ADMIN')) %}
                        <div class="pull-right">
                            <div class="pull-right" data-toggle="tooltip" data-placement="top" title="Delete This Project">
                                <a style="cursor: pointer; text-decoration: none;" data-toggle="modal" data-target="#delete_private_project">
                                    <i class="fa text-danger fa-fw fa-trash  fa-2x"></i>
                                </a>
                            </div>

                            <div class="pull-right" data-toggle="tooltip" data-placement="top" title="Project Settings">
                                <a style="cursor: pointer; text-decoration: none;" href="{{ path('zectranet_settings_project', {'project_id': project.id }) }}">
                                    <i class="fa text-primary fa-fw fa-gear fa-2x"></i>
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    <!-- End of Project controll buttons -->
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-md-6">
                <div class="list-group">
                    <div class="list-group-item active">
                        Project
                    </div>
                    <a class="list-group-item" style="cursor: pointer;"
                       ng-click="changeCurrentPage({{ project.id }}); removeHighlightFromEpicStories();">
                        <i class="fa fa-briefcase"></i>
                        {{ project.name }}
                    </a>
                    <div class="list-group-item active">Project Description:</div>
                    <div class="list-group-item">{{ project.description }}</div>
                </div>
            </div>
            <div class="col-xs-12 col-md-6">
                <div class="list-group">
                    <div class="list-group-item active">
                        Epic Stories
                    </div>
                    <div cg-busy="promiseProject">
                        <a class="list-group-item" ng-repeat="story in epicStories" style="cursor: pointer;"
                           ng-init="story.selected = false;" ng-class="{'list-group-item-success': story.selected }"
                           ng-click="changeCurrentPage(story.id); highlightCurrentEpicStory(story.id);">
                            <i class="fa fa-briefcase"></i>
                            [[ story.name ]]
                        </a>
                        <div class="list-group-item" ng-if="epicStories.length == 0">
                            <h4 class="text-center text-info">Epic Stories will be displayed here</h4>
                        </div>
                        {% if app.user.id == project.owner.id %}
                            <div class="form-group">
                                <button type="button" data-toggle="modal" data-target="#add_epic_story" class="form-control btn btn-default btn-success">
                                    <i class="fa fa-plus-circle"></i>
                                    Add New Epic Story
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- BEGIN OF EPIC STORY ADD MODAL -->
            {% include '@Zectranet/projectAddEpicStory.html.twig' %}
            <!-- END OF EPIC STORY ADD MODAL -->

        </div>

        <!-- Begin of Tasks -->
        <div class="row" ng-controller="TaskController">

            <div class="col-md-12">
                <div class="panel panel-default list-group">

                    {% include '@Zectranet/filter.html.twig' %}

                    <div class="list-group-item active">
                        <i class="fa fa-tasks"></i>
                        <span>Tasks</span>
                    </div>

                    <div cg-busy="promise" class="panel-body">
                        <!-- Begin of Task Nav Tabs -->
                        <ul id="task-view-tabs" class="nav nav-tabs" role="tablist">
                            <li data-toggle="tooltip" data-placement="top" title="Table view" role="presentation" class="active">
                                <a data-toggle="tab" id="task-view-table" class="btn" href="#table-view" aria-controls="table-view" role="tab" aria-expanded="true">
                                    <i class="fa fa-table fa-2x"></i>
                                </a>
                            </li>
                            {#
                            <li data-toggle="tooltip" data-placement="top" title="List view" role="presentation">
                                <a data-toggle="tab" id="task-view-list" class="btn" href="#list-view" aria-controls="list-view" role="tab" aria-expanded="false">
                                    <i class="fa fa-list fa-2x"></i>
                                </a>
                            </li>
                            #}
                            <li data-toggle="tooltip" data-placement="top" title="Agile view" role="presentation">
                                <a data-toggle="tab" id="task-view-agile"  class="btn" href="#agile-view" aria-controls="agile-view" role="tab" aria-expanded="false">
                                    <i class="fa fa-th fa-2x"></i>
                                </a>
                            </li>
                            <li data-toggle="tooltip" data-placement="top" title="Add new task" role="presentation">
                                <a id="add_new_task_btn" style="cursor: pointer" data-toggle="modal" data-target="#add_new_task">
                                    <i class="fa fa-plus fa-2x"></i>
                                </a>
                            </li>
                        </ul>
                        <!-- End of Task Nav Tabs -->

                        <div id="tasks-tab-content" class="tab-content">

                            <!-- Begin of Task Table View -->
                            <div id="table-view" class="tab-pane fade in active" aria-labelledby="task-view-table" role="tabpanel">
                                <ng-include src="{{ '\'' ~ asset('bundles/zectranet/templates/task-table.html') ~ '\'' }}"></ng-include>
                            </div>
                            <!-- End of Task Table View -->

                            {#
                            <!-- Begin of Task List View -->
                            <div id="list-view" class="tab-pane fade" aria-labelledby="task-view-list" role="tabpanel">
                                <ng-include src="{{ '\'' ~ asset('bundles/zectranet/templates/task-list.html') ~ '\'' }}"></ng-include>
                            </div>
                            <!-- End of Task List View -->
                            #}

                            <!-- Begin of Task Agile View -->
                            <div id="agile-view" class="tab-pane fade" aria-labelledby="task-view-agile" role="tabpanel">
                                <ng-include src="{{ '\'' ~ asset('bundles/zectranet/templates/task-agile.html') ~ '\'' }}"></ng-include>
                            </div>
                            <!-- End of Task Agile View -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Begin of Task operations modals -->
            {% include '@Zectranet/taskAdd.html.twig' %}

            {% include '@Zectranet/taskAddSub.html.twig' %}

            {% include '@Zectranet/taskDelete.html.twig' %}

            {% include '@Zectranet/projectAddTaskToSprint.html.twig' %}
            <!-- End of Task operations modals -->

        </div>
        <!-- End of Tasks -->

        <div class="row">
            <!-- BEGIN OF OFFICE USERS PANEL -->
            <div class="col-md-12 col-xs-12">
                <div class="list-group">
                    <div class="list-group-item active">
                        <i class="fa fa-users"></i>
                        Project Users
                    </div>
                    <div class="list-group-item">
                        <div class="row">
                            {% set projectUsersCount = project.users | length %}
                            {% for user in project.users %}
                                <div class="col-md-2 col-xs-4">
                                    <div class="user-chat center-block">
                                        <a href="{{ path('zectranet_user_page', {'user_id': user.id}) }}" style="display: block; text-decoration: none;">
                                            <p class="text-muted label label-default label-primary text-center center-block" style="margin-bottom: 1px;">Manager</p>
                                            <img src="{{ asset('') ~ 'documents/' ~ user.avatar }}" class="img-responsive center-block" style="width: 60px; height: 60px;">
                                        </a>
                                        <a style="cursor: pointer;">
                                            <p class="text-center" style="font-weight: bold;">{{ user.name ~ ' ' ~ user.surname ~ ' (' ~ user .username ~ ')'}}</p>
                                        </a>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for office in project.offices %}
                                {% set projectUsersCount = projectUsersCount + office.users | length %}
                                {% for user in office.users %}
                                    <div class="col-md-2 col-xs-4">
                                        <div class="user-chat center-block">
                                            <a href="{{ path('zectranet_user_page', {'user_id': user.id}) }}" style="display: block; text-decoration: none;">
                                                <p class="text-muted label label-default label-primary text-center center-block" style="margin-bottom: 1px;">Manager</p>
                                                <img src="{{ asset('') ~ 'documents/' ~ user.avatar }}" class="img-responsive center-block" style="width: 60px; height: 60px;">
                                            </a>
                                            <a style="cursor: pointer;">
                                                <p class="text-center" style="font-weight: bold;">{{ user.name ~ ' ' ~ user.surname ~ ' (' ~ user .username ~ ')'}}</p>
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endfor %}

                            {% if projectUsersCount == 0 %}
                                <div class="col-md-12">
                                    <h4 class="text-center text-info">Members will be displayed here</h4>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <!-- END OF OFFICE USERS PANEL -->
        </div>

        <div class="row">
            <div class="col-xs-12 col-md-12">
                <!-- BEGIN OF CHAT PANEL -->
                <div class="chat-panel list-group" ng-controller="ChatController">
                    <div class="list-group-item active">
                        <i class="fa fa-comments fa-fw"></i>
                        Project Chat
                    </div>
                    <div class="list-group-item panel-body" cg-busy="promise" style="max-height: 300px;">
                        <div ng-if="(posts == null) || (posts.length == 0)" class="center-block vertical-center">
                            <h3 class="text-info text-center">Post will be displayed here</h3>
                        </div>

                        <ng-include src="{{ '\'' ~ asset('bundles/zectranet/templates/chat.html') ~ '\'' }}"></ng-include>

                    </div>
                    <div class="list-group-item">
                        <form class="input-group input-group-lg">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button" style="height: 65px;"  data-placement="top" id="add_dialog_btn"  data-toggle="modal" data-target="#add_dialog">
                                    <i class="fa fa-file"></i>
                                </button>
                            </span>
                            <textarea id="textarea-post" name="message" class="form-control" rows="3" style="font-size: 11px; height: 65px;" ng-keypress="pressEnter($event)" ng-model="message"></textarea>
                        <span class="input-group-btn">
                            <button class="btn btn-primary" name="subscribe" type="button" style="height: 65px; font-size:15px;" ng-click="SendPost(message)">
                                <span>Post</span>
                            </button>
                        </span>
                        </form>
                        <div id="slide-down-menu-screenshots" style="display: none;">
                            <div id="div-screenshot" style="display: none; width: auto;height: auto;">

                            </div>
                            <button class="btn text-white bg-primary send-message" type="button" id="send-message" ng-click="InsertScreenshotsInChat()" style="width: 100%; height: 40px; margin-top: 10px;">Insert Screenshots in chat</button>
                        </div>
                    </div>
                </div>
                <!-- END OF CHAT PANEL -->
                {% include '@Zectranet/dialogAdd.html.twig' %}
            </div>
        </div>

        <div ng-init="changeCurrentPage('{{ project.id }}')"></div>
    </div>

    {% if project.owner.id == app.user.id or (is_granted('ROLE_ADMIN')) %}
        <!-- Begin of Delete Private Project Modal -->
        {% include '@Zectranet/projectDelete.html.twig' %}
        <!-- End of Delete Private Project Modal -->
    {% endif %}

{% endblock %}

{% block modals %}
    {{ parent() }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        $('#task-view-tabs a').click(function (e) {
            if ($(this).id != $('a#add_new_task_btn').id) {
                $(this).tab('show');
            }
            e.preventDefault();
        });

        JSON_URLS.addPost = "{{ path('zectranet_project_add_post', { 'project_id': 0 }) }}";
        JSON_URLS.getPosts = "{{ path('zectranet_project_get_post', { 'project_id': 0 }) }}";

        JSON_URLS.addTask = "{{ path('zectranet_project_add_task', { 'project_id': 0 }) }}";
        JSON_URLS.addSubTask = "{{ path('zectranet_project_add_subtask', { 'project_id': 0 }) }}";
        JSON_URLS.getTasks = "{{ path('zectranet_project_get_tasks', { 'project_id': 0 }) }}";
        JSON_URLS.deleteTask = "{{ path('zectranet_task_delete', { 'task_id': 0 }) }}";
        JSON_URLS.showTask = "{{ path('zectranet_task_show', { 'task_id': 0 }) }}";

        JSON_URLS.getEpicStories = "{{ path('zectranet_project_get_epic_stories', { 'project_id': project.id }) }}";
        JSON_URLS.addEpicStory = "{{ path('zectranet_project_add_epic_story', { 'project_id': project.id }) }}";

        JSON_URLS.showSprint = "{{ path('zectranet_show_sprint', { 'office_id': 0, 'sprint_id': 1 }) }}";
        JSON_URLS.sprintAddTasks = "{{ path('zectranet_sprint_add_tasks', { 'sprint_id': 0 }) }}";

    </script>

    <script src="{{ asset('bundles/zectranet/js/custom/chatController.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/custom/taskController.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/custom/projectController.js') }}" type="text/javascript"></script>

    <script src="{{ asset('bundles/zectranet/js/custom/documentsController.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/upload/jquery.knob.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/upload/jquery.ui.widget.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/upload/jquery.iframe-transport.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/upload/jquery.fileupload.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/zectranet/js/upload/script.js') }}" type="text/javascript"></script>

    <script>
        var getDocuments_;
        JSON_URLS.documentsGet = "{{ path('zectranet_document_get') }}";
        JSON_URLS.deleteFile  = "{{ path('zectranet_document_delete', { fileid : 0 }) }}";
        JSON_URLS.renameFile  = "{{ path('zectranet_document_rename', { fileid : 0 }) }}";
        var NOW = '{{ "now" | date('Y-m-d') }}';

        $('.noclose').bind('click', function (e) {
            e.stopPropagation();
        });
    </script>
{% endblock %}